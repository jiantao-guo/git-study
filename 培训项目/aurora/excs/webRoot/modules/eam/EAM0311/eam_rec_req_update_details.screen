<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: StephenWang4010  
    $Date: 2013-2-27 下午2:20:10  
    $Revision: 1.0  
    $Purpose: 资产验收申请行信息创建
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application">
    <a:init-procedure>
        <a:model-query fetchAll="true" model="eam.eam0311.eam0311_requisition_headers_edit" rootPath="eam0310_req_header"/>
        <a:model-query fetchAll="true" model="eam.eam0310.eam0310_employee_assigns_lov" rootPath="eam0310_employee"/>
        <a:model-query autoCount="false" model="expm.get_sys_image_url" rootPath="image_url"/>
        <a:model-query autoCount="false" defaultWhereClause=" user_id=${/session/@user_id}" fetchAll="true" model="sys.sys_user" rootPath="employee"/>
        <a:model-query autoCount="false" defaultWhereClause="e.employee_id = ${/model/employee/record/@employee_id}" model="expm.cux_exp_get_unit_info" rootPath="unit"/>
    </a:init-procedure>
    <a:view>
        <!-- <a:link id="eam0310_asset_management" url="${/request/@context_path}/modules/eam/EAM0311/eam_asset_management.screen"/> -->
        <a:link id="eam0310_asset_management" url="${/request/@context_path}/modules/eam/EAM0311/eam_asset_management.screen"/>
        <a:link id="eam0311_asset_update" url="${/request/@context_path}/modules/eam/EAM0311/eam_asset_management_update.screen"/>
        <a:link id="eam0311_asset_batch_creation_link" url="${/request/@context_path}/modules/eam/EAM0311/eam_asset_management_batch_creation.screen"/>
        <a:link id="eam0311_asset_batch_ref_req_link" url="${/request/@context_path}/modules/eam/EAM0311/eam_asset_rec_req_batch_ref_exp_req.screen"/>
        <a:link id="eam0311_asset_batch_ref_req_tmp_record_link" url="${/request/@context_path}/modules/eam/EAM0310/eam_asset_rec_batch_ref_req.svc"/>
        <!-- <a:link id="cux_create_image_url_id_link1" model="sys.cux_sys_create_image_url" modelaction="batch_update"/> -->
        <script><![CDATA[
            // 初始化加载
            Aurora.onReady(eam0310_query);
            
            var c_static_param = false;
            // 资产信息链接
            
            function eam0310_assetRenderer(value, record, name) {
                var asset_id = record.get("asset_id");
                var requisition_line_id = record.get("requisition_line_id");
                var requisition_header_id = '${/parameter/@requisition_header_id}';
                var asset_book_id = '${/model/eam0310_req_header/record/@asset_book_id}';
                var ast_requisition_type_id = '${/model/eam0310_req_header/record/@ast_requisition_type_id}';
                var value_type = '${/model/eam0310_req_header/record/@value_type}';
            
                return '<a href="javascript:eam0310_assetManage(' + requisition_header_id + ',' + ast_requisition_type_id + ',' + asset_book_id + ',' + asset_id + ',' + requisition_line_id + ',\'' + value_type + '\')">${l:EAM_ASSET_HEADERS.ASSET_MESSAGE}</a>';
            }
            
            // 资产信息管理
            
            function eam0310_assetManage(requisition_header_id, ast_requisition_type_id, asset_book_id, asset_id, requisition_line_id, value_type) {
            
                var ast_requisition_type_code = '${/model/eam0310_req_header/record/@ast_requisition_type_code}';
                var url_new = $('eam0310_asset_management').getUrl() + '?requisition_header_id=' + requisition_header_id + '&ast_requisition_type_id=' + ast_requisition_type_id + '&asset_book_id=' + asset_book_id + '&ast_requisition_type_code=' + ast_requisition_type_code + '&entity_unit_id=' + '${/model/eam0310_req_header/record/@unit_id}' + '&value_type=' + value_type;
                var url_update = $('eam0311_asset_update').getUrl() + '?requisition_header_id=' + requisition_header_id + '&ast_requisition_type_id=' + ast_requisition_type_id + '&asset_book_id=' + asset_book_id + '&requisition_line_id=' + requisition_line_id + '&asset_id=' + asset_id + '&ast_requisition_type_code=' + ast_requisition_type_code + '&entity_unit_id=' + '${/model/eam0310_req_header/record/@unit_id}' + '&value_type=' + value_type;
            
                var to_url = !asset_id ? url_new : url_update;
            
                if (!asset_id) {
                    Aurora.request({
                        url: '${/request/@context_path}/autocrud/eam.eam0310.eam0310_get_asset_id/query',
                        success: function(args) {
                            var input_asset_id = args.result.record.input_asset_id;
                            to_url = to_url + '&input_asset_id=' + input_asset_id;
                            new Aurora.Window({
                                id: 'eam0310_assetManage_screen',
                                url: to_url,
                                fullScreen: true,
                                shadow: false,
                                modal: true
                            }).on('close', function() {
                                Aurora.Masker.unmask(Ext.getBody());
                                $('eam0310_req_lines_ds').setQueryParameter('requisition_header_id', requisition_header_id);
                                $('eam0310_req_lines_ds').query();
                            });
                        }
                    });
            
                } else {
                    new Aurora.Window({
                        id: 'eam0310_assetManage_screen',
                        url: to_url,
                        fullScreen: true,
                        shadow: false,
                        modal: true
                    }).on('close', function() {
                        Aurora.Masker.unmask(Ext.getBody());
                        $('eam0310_req_lines_ds').setQueryParameter('requisition_header_id', requisition_header_id);
                        $('eam0310_req_lines_ds').query();
                    });
            
                }
            }
            
            // 行信息添加时，直接弹出资产台账页面
            
            function eam0310_onReqLinesAdd() {
            
                //20160106 行数不超过20行 双保险
            
                var line_rec = $('eam0310_req_lines_ds').getAll();
                if (line_rec.length > 20) {
                    Aurora.showErrorMessage('${l:PROMPT}', '请注意，单据行数不能超过20行！', null, 250, 100);
                    $('eam0310_req_lines_ds').remove($('eam0310_req_lines_ds').getAt(20));
                    return false;
                }
            
            
                var requisition_header_id = '${/parameter/@requisition_header_id}';
                var asset_book_id = '${/model/eam0310_req_header/record/@asset_book_id}';
                var ast_requisition_type_id = '${/model/eam0310_req_header/record/@ast_requisition_type_id}';
            
                eam0310_assetManage(requisition_header_id, ast_requisition_type_id, asset_book_id);
                //return false;
            }
            // 行信息删除时，重新查询行信息
            
            function eam0310_onReqLinesDel() {
                eam0310_query();
            }
            // 点击岗位时查询
            
            function eam0310_onPosFocusHandler() {
                var employee_id = '${/model/eam0310_req_header/record/@employee_id}';
                $('eam0310_org_position_ds').setQueryParameter('employee_id', employee_id);
                $('eam0310_org_position_ds').query();
            }
            
            // 整单删除
            
            function eam0310_delete() {
                var confirm = window.confirm('${l:EXP_REQUESTION_READONLY.SURE_DELETE_REQ}');
                if (!confirm) {
                    return false;
                }
            
                var requisition_header_id = '${/parameter/@requisition_header_id}';
                Aurora.Masker.mask(Ext.getBody(), '${l:AST_ASSET.WAITING_FOR_OPERATION}');
                Aurora.request({
                    url: '${/request/@context_path}/autocrud/eam.eam0311.eam0311_requisition_headers_edit/delete?requisition_header_id=' + requisition_header_id,
                    success: function(args) {
                        Aurora.Masker.unmask(Ext.getBody());
                        Aurora.go('${/request/@context_path}/modules/eam/EAM0311/eam_rec_requisition_update.screen');
                    },
                    failure: function(args) {
                        Aurora.Masker.unmask(Ext.getBody());
                    },
                    error: function(args) {
                        Aurora.Masker.unmask(Ext.getBody());
                    }
                });
            }
            
            function eam0310_save() {
            
                if (!$('eam0310_req_form_ds').validate()) {
                    return false;
                }
            
                // var doc_records = $('eam0310_document_release_ds').getAll();
                // for (var i = 0;i < doc_records.length;i++) {
                // var doc_rec = doc_records[i];
                // if(doc_rec.get('release_quantity') != 1){
                // Aurora.showErrorMessage('${l:PROMPT}', '购置数量无效');
                // return false;
                // }
                // }
            
                $('eam0310_document_release_ds').submit();
            
                var record = $('eam0310_req_form_ds').getCurrentRecord();
                var data = record.data;
            
                var operation_unit_id = '${/model/eam0310_req_header/record/@operation_unit_id}';
                var position_id = '${/model/eam0310_req_header/record/@position_id}';
                var unit_id = '${/model/eam0310_req_header/record/@unit_id}';
                var ast_requisition_type_id = '${/model/eam0310_req_header/record/@ast_requisition_type_id}';
                var attachment_num = '${/model/eam0310_req_header/record/@attachment_num}';
                var source_type = '${/model/eam0310_req_header/record/@source_type}';
                var employee_id = '${/model/eam0310_req_header/record/@employee_id}';
            
                data.req_lines = null;
                data.operation_unit_id = operation_unit_id;
                data.employee_id = employee_id;
                data.position_id = position_id;
                data.unit_id = unit_id;
                data.ast_requisition_type_id = ast_requisition_type_id;
                data.attachment_num = attachment_num;
                data.source_type = source_type;
                data.req_desc = record.get("req_desc");
            
                //----------------------------
                // var ast_requisition_type_code = '${/model/eam0310_req_header/record/@ast_requisition_type_code}';
                // if(ast_requisition_type_code == 'QD003'){
                // var urls = "${/request/@context_path}/autocrud/eam.eam0310.eam0310_asset_cost_sources_edit/query?asset_id=${/parameter/@asset_id}&amp;document_id=${/parameter/@requisition_header_id}&amp;document_line_id=${/parameter/@requisition_line_id}";
                // alert(urls);
                // Aurora.request({
                // url: urls,
                // success: function(args) {
                // var cost = args.result.record.cost;
                // alert(cost);
                // }
                // });
                // }
                var requisition_header_id = '${/parameter/@requisition_header_id}';
                Aurora.request({
                    url: '${/request/@context_path}/autocrud/eam.eam0311.eam0311_requisition_headers_edit/update',
                    para: data,
                    success: function(args) {
                        eam0310_query();
                    }
                });
            }
            
            // 头行保存之后提示成功
            
            function eam0311_onReqFormSubmited() {
                alert('${l:BGT_BUDGET_STRUCTURE_DIMENSION.SAVE_SUC}');
            }
            
            // 提交
            
            function eam0310_submit() {
                if (!$('eam0310_req_form_ds').validate()) {
                    return false;
                }
            
                Aurora.showConfirm('提示', '${l:EAM_SUBMIT_REQUISITION_CONFIRM}', function() {
                    eam0310_submit1();
                }, function() {
                    return;
            
                }, null, 85);
            
            }
            
            function eam0310_submit1() {
            
            
                // var confirm = window.confirm('${l:EAM_SUBMIT_REQUISITION_CONFIRM}');
            
                // if (!confirm) {
            
                // }
            
                var ast_requisition_type_code = '${/model/eam0310_req_header/record/@ast_requisition_type_code}';
            
                var doc_records = $('eam0310_document_release_ds').getAll();
            
                //存在源资产卡片号不能关联费用，否则必须关联
                // if(ast_requisition_type_code == "QD006"){
                // if(c_static_param && doc_records.length == 0){
                // Aurora.showErrorMessage('${l:PROMPT}', '请关联费用申请单！');
                // return false;
                // }
                // if(!c_static_param && doc_records.length > 0){
                // Aurora.showErrorMessage('${l:PROMPT}', '该资产不能关联费用申请单！');
                // return false;
                // }
                // }
            
                for (var i = 0;i < doc_records.length;i++) {
                    var doc_rec = doc_records[i];
                    if (doc_rec.get('release_quantity') != 1) {
                        Aurora.showErrorMessage('${l:PROMPT}', '核销数量无效');
                        return false;
                    }
                }
                var record = $('eam0310_req_form_ds').getCurrentRecord();
                var data = record.data;
            
                var operation_unit_id = '${/model/eam0310_req_header/record/@operation_unit_id}';
                var position_id = '${/model/eam0310_req_header/record/@position_id}';
                var unit_id = '${/model/eam0310_req_header/record/@unit_id}';
                var ast_requisition_type_id = '${/model/eam0310_req_header/record/@ast_requisition_type_id}';
                var attachment_num = '${/model/eam0310_req_header/record/@attachment_num}';
                var source_type = '${/model/eam0310_req_header/record/@source_type}';
                var employee_id = '${/model/eam0310_req_header/record/@employee_id}';
            
                data.req_lines = null;
                data.operation_unit_id = operation_unit_id;
                data.employee_id = employee_id;
                data.position_id = position_id;
                data.unit_id = unit_id;
                data.ast_requisition_type_id = ast_requisition_type_id;
                data.attachment_num = attachment_num;
                data.source_type = source_type;
                data.req_desc = record.get("req_desc");
            
                Aurora.Masker.mask(Ext.getBody(), '${l:AST_ASSET.WAITING_FOR_OPERATION}');
                //jhyh
                if (ast_requisition_type_code == "QD003") {
                    Aurora.request({
                        url: '${/request/@context_path}/autocrud/eam.eam0311.eam0311_asset_check_add_cost/query?requisition_header_id=${/parameter/@requisition_header_id}&ast_requisition_type_code=' + ast_requisition_type_code,
                        success: function(args) {
                            var check_flag = args.result.record.check_flag;
                            if (check_flag == 'N') {
                                if (ast_requisition_type_code == "QD003") {
                                    Aurora.showWarningMessage('${l:PROMPT}', '成本来源本次结转金额与资产金额不匹配，无法提交！');
                                } else {
                                    Aurora.showWarningMessage('${l:PROMPT}', '成本来源本次结转金额与费用申请单核销金额之和与资产金额不匹配，无法提交！');
                                }
                                Aurora.Masker.unmask(Ext.getBody());
                                return false;
                            } else if (check_flag == 'X') {
                                Aurora.showWarningMessage('${l:PROMPT}', '成本来源卡片信息没有维护，无法提交！');
                                Aurora.Masker.unmask(Ext.getBody());
                                return false;
                            } else if (check_flag == 'E') {
                                Aurora.showWarningMessage('${l:PROMPT}', '成本来源卡片信息不符合要求，无法提交！');
                                Aurora.Masker.unmask(Ext.getBody());
                                return false;
                            } else {
                                Aurora.request({
                                    url: '${/request/@context_path}/autocrud/eam.eam0311.eam0311_requisition_headers_edit/execute',
                                    para: data,
                                    success: function(args) {
                                        Aurora.Masker.unmask(Ext.getBody());
                                        Aurora.go('${/request/@context_path}/modules/eam/EAM0311/eam_rec_requisition_update.screen');
                                    },
                                    failure: function(args) {
                                        Aurora.Masker.unmask(Ext.getBody());
                                    },
                                    error: function(args) {
                                        Aurora.Masker.unmask(Ext.getBody());
                                    }
                                });
                            }
                        }
                    });
                } else {
                    Aurora.request({
                        url: '${/request/@context_path}/autocrud/eam.eam0311.eam0311_requisition_headers_edit/execute',
                        para: data,
                        success: function(args) {
                            Aurora.Masker.unmask(Ext.getBody());
                            Aurora.go('${/request/@context_path}/modules/eam/EAM0311/eam_rec_requisition_update.screen');
                        },
                        failure: function(args) {
                            Aurora.Masker.unmask(Ext.getBody());
                        },
                        error: function(args) {
                            Aurora.Masker.unmask(Ext.getBody());
                        }
                    });
                }
            }
            
            // 查询
            
            function eam0310_query() {
                var requisition_header_id = '${/parameter/@requisition_header_id}';
                var ast_requisition_type_code = '${/model/eam0310_req_header/record/@ast_requisition_type_code}';
                var ref_required_flag = '${/model/eam0310_req_header/record/@ref_required_flag}';
                /* if (ref_required_flag != 'Y') {
                    Ext.get('batch_ref_req_id').setStyle('display', 'none');
                    Ext.get('batch_creation_id').setStyle('display', 'none');
                    document.getElementById('grid_release_id').style.display = 'none';
                } */
                $('eam0310_req_lines_ds').setQueryParameter('requisition_header_id', requisition_header_id);
                $('eam0310_req_lines_ds').query();
                $('eam0310_document_release_ds').setQueryParameter('requisition_header_id', requisition_header_id);
                $('eam0310_document_release_ds').query();
                //存在原资产卡片号不能关联费用申请单，否则必须关联
                //jhcw c_static_param 已注释
                // if (ast_requisition_type_code == "QD006") {
                // Aurora.request({
                // url: '${/request/@context_path}/autocrud/eam.eam0311.eam0311_asset_check_add_release/query?requisition_header_id=' + requisition_header_id,
                // success: function(args) {
                // var check_flag = args.result.record.check_flag;
                // if (check_flag == 'Y') {
                // // $('addButton').disable();
                // c_static_param = false;
                // } else {
                // // $('addButton').enable();
                // c_static_param = true;
                // }
                // }
                // });
                // }
            }
            
            // 申请行索引更改时
            
            function eam0310_onReqLinesIndexChange(dataset, record) {
                var requisition_header_id = record.get("requisition_header_id");
                var requisition_line_id = record.get("requisition_line_id");
                var tag_number_old = record.get("tag_number_old");
                // if(tag_number_old){
                // $('addButton').disable();
                // }else{
                // $('addButton').enable();
                // }
                $('eam0310_document_cates_ds').setQueryParameter('requisition_header_id', requisition_header_id);
                $('eam0310_document_cates_ds').setQueryParameter('requisition_line_id', requisition_line_id);
                $('eam0310_document_cates_ds').query();
            }
            
            //
            
            function eam0310_onDocRlsAdd(dataSet, record, index) {
                var records = $('eam0310_req_lines_ds').getAll();
                if (records.length < 1) {
                    Aurora.showWarningMessage('${l:PROMPT}', '${l:AT_LEAST_CHOICE_ONE}');
                    return false;
                }
                records = $('eam0310_req_lines_ds').getCurrentRecord();
                var source_doc_desc = record.getField('source_doc_desc');
                record.set('source_document_category', 'EXP_RPT');
                record.set('source_doc_cate_desc', '费用报销单');
                var requisition_header_id = '${/parameter/@requisition_header_id}';
                record.set('requisition_header_id', requisition_header_id);
            }
            
            function eam0310_back() {
                // $('req_update_detail').close();
                Aurora.go('${/request/@context_path}/modules/eam/EAM0311/eam_rec_requisition_update.screen');
            }
            
            //批量新增 @Spencer 3893
            
            function eam0310_batch_creation() {
                var requisition_header_id = '${/parameter/@requisition_header_id}';
                var asset_book_id = '${/model/eam0310_req_header/record/@asset_book_id}';
                var ast_requisition_type_id = '${/model/eam0310_req_header/record/@ast_requisition_type_id}';
                var ast_requisition_type_code = '${/model/eam0310_req_header/record/@ast_requisition_type_code}';
                Aurora.request({
                    url: '${/request/@context_path}/autocrud/eam.eam0310.eam0310_get_asset_id/query',
                    success: function(args) {
                        var input_asset_id = args.result.record.input_asset_id;
                        var url = $('eam0311_asset_batch_creation_link').getUrl() + '?requisition_header_id=' + requisition_header_id + '&ast_requisition_type_id=' + ast_requisition_type_id + '&asset_book_id=' + asset_book_id + '&input_asset_id=' + input_asset_id + '&ast_requisition_type_code=' + ast_requisition_type_code + '&entity_unit_id=' + '${/model/eam0310_req_header/record/@unit_id}';
                        new Aurora.Window({
                            id: 'eam0310_batch_assetManage_screen',
                            url: url,
                            fullScreen: true
                        }).on('close', function() {
                            $('eam0310_req_lines_ds').setQueryParameter('requisition_header_id', requisition_header_id);
                            $('eam0310_req_lines_ds').query();
                        });
                    }
                });
            }
            
            //批量关联申请 @Spencer 3893
            
            function eam0310_batch_ref_req() {
                var records = $('eam0310_req_lines_ds').getSelected();
            
                if (records.length < 1) {
                    Aurora.showWarningMessage('${l:PROMPT}', '${l:AT_LEAST_CHOICE_ONE}');
                    return;
                }
                var select_num = records.length;
                var ast_requisition_type_id = '${/model/eam0310_req_header/record/@ast_requisition_type_id}';
                var company_id = '${/model/eam0310_req_header/record/@company_id}';
                var requisition_header_id = '${/parameter/@requisition_header_id}';
            
                var data = [];
                var using_unit_id = "";
                var tag_number_old_flag = "N";
                var line_number = "";
                for (var i = 0;i < records.length;i++) {
                    //校验使用部门是否相同
                    if (i == 0) {
                        using_unit_id = records[i].data.to_unit_id;
                    }
                    // if(using_unit_id != records[i].data.to_unit_id){
                    // Aurora.showWarningMessage('${l:PROMPT}', '只能批量关联相同使用部门的申请单！');
                    // return false;
                    // }
                    var tag_number_old = records[i].get("tag_number_old");
                    if (tag_number_old) {
                        line_number = line_number + records[i].get("line_number") + ",";
                        if (tag_number_old_flag == "N") {
                            tag_number_old_flag = "Y";
                        }
                    }
                    var para = {};
                    para.requisition_header_id = requisition_header_id;
                    para.requisition_line_id = records[i].data.requisition_line_id;
            
                    data.push(para);
                }
                if (line_number != "") {
                    line_number = line_number.substr(0, line_number.length - 1);
                }
                if (tag_number_old_flag == "Y") {
                    Aurora.showWarningMessage('${l:PROMPT}', '行号为' + line_number + '的申请存在原卡片号，不能批量关联申请！');
                    return false;
                }
                Aurora.request({
                    url: $('eam0311_asset_batch_ref_req_tmp_record_link').getUrl(),
                    para: data,
                    success: function(args) {
                        var ast_requisition_type_code = '${/model/eam0310_req_header/record/@ast_requisition_type_code}';
                        var url = $('eam0311_asset_batch_ref_req_link').getUrl() + '?ast_requisition_type_id=' + ast_requisition_type_id + '&select_num=' + select_num + '&unit_id=' + using_unit_id + '&ast_requisition_type_code=' + ast_requisition_type_code + '&company_id=' + company_id;
                        new Aurora.Window({
                            id: 'eam0310_batch_ref_req_screen',
                            url: url,
                            height: 500,
                            width: 1000
                        }).on('close', function() {
                            $('eam0310_req_lines_ds').setQueryParameter('requisition_header_id', requisition_header_id);
                            $('eam0310_req_lines_ds').query();
                            $('eam0310_document_release_ds').setQueryParameter('requisition_header_id', requisition_header_id);
                            $('eam0310_document_release_ds').query();
                        });
                    }
                });
            }
            //影像上传
            
            function uploadImage() {
                var requisition_number = '${/model/eam0310_req_header/record/@requisition_number}';
                var url = '${/model/image_url/record/@url}';
                url = url + '?operID=' + '${/session/@user_id}' + '&operName=' + '${/model/employee/record/@description}' + '&operOrgID=' + '${/model/unit/record/@unit_id}' + '&operOrgName=' + '${/model/unit/record/@description}' + '&right=' + '020' + '&businessCode=' + 'CW' + '&businessAppNo=' + requisition_number + '&batchID=' + '&scanMode=0';
                // window.open(encodeURI(url));
                var datas = [];
                var data = {
                    url: url,
                    _status: 'insert'
                };
                datas.push(data);
            
                Aurora.request({
                    url: $('cux_create_image_url_id_link1').getUrl(),
                    para: datas,
                    success: function(res) {
                        if (res.result.record.image_id) {
                            open_image_url(res.result.record.image_id);
                        }
                    },
                    scope: this
                });
            }
            
            function open_image_url(image_id) {
                var screenWidth = Aurora.getViewportWidth() - 30;
                var screenHeight = Aurora.getViewportHeight() - 15;
                window.open('${/request/@context_path}/cux_sys_image.screen?widthurl=' + screenWidth + '&heighturl=' + screenHeight + '&image_id=' + image_id);
            }
            
            function docRlsValidator(record, name, value) {
            
                if (name == 'release_amount') {
                    var examine_amount = record.get('examine_amount');
                    var release_amount_sum = record.get('release_amount_sum');
                    var release_amount = record.get('release_amount');
                    var req_amount = record.get("req_amount");
                    //alert("release_amount_sum + release_amount > examine_amount = "+"1:"+release_amount_sum+" 2:"+release_amount+" 3:"+examine_amount);
                    if (release_amount > examine_amount) {
                        return '核销金额无效!';
                    }
                    if(release_amount > req_amount){
                        return '核销金额大于行金额！请重新填写。';
                    }
                    return true;
                }
            }
            
            function eam_onCellClickFun(grid, row, name, record) {
            
                if (name == 'source_doc_desc') {
                    var lovField = record.getField("source_doc_desc");
                    if (record.get('source_document_category') == 'EXP_RPT') {
                        // lovField.setLovService('eam.eam0310.eam0310_exp_report_query');
                        // lovField.setLovPara('ast_requisition_type_id', '${/model/eam0310_req_header/record/@ast_requisition_type_id}');
                        // lovField.setLovPara('company_id', '${/model/eam0310_req_header/record/@company_id}');
                        var ast_requisition_type_id = '${/model/eam0310_req_header/record/@ast_requisition_type_id}';
                        var company_id = '${/model/eam0310_req_header/record/@company_id}';
                        lovField.setLovUrl("${/request/@context_path}/modules/eam/EAM0310/eam_exp_requisition_lov.screen?ast_requisition_type_id=" + ast_requisition_type_id + "&company_id=" + company_id);
                        var mapping = [{
                            from: 'exp_report_header_id',
                            to: 'source_document_id'
                        }, {
                            from: 'exp_report_line_id',
                            to: 'source_document_line_id'
                        }, {
                            from: 'exp_report_number',
                            to: 'source_doc_desc'
                        }, {
                            from: 'line_number',
                            to: 'source_doc_line_desc'
                        }, {
                            from: 'primary_quantity',
                            to: 'req_quantity'
                        }, {
                            from: 'report_amount',
                            to: 'req_amount'
                        }, {
                            from: 'price',
                            to: 'price'
                        }, {
                            from: 'unit_name',
                            to: 'unit_name'
                        }, {
                            from: 'expense_item_name',
                            to: 'req_project'
                        }];
                        lovField.setMapping(mapping);
                    } else {
            
                        //资产验收时（资产取得验收申请(固定资产/无形资产)、低值易耗品验收申请、长期待摊费用验收申请、在建工程验收申请），在关联申请单时，只能选择资产财务分类对应的费用类型的申请单
                        // --QD001  QD002  QD008  QD006
                        // jhyh
                        var ast_requisition_type_code = '${/model/eam0310_req_header/record/@ast_requisition_type_code}';
                        if ((ast_requisition_type_code == 'QD001') || (ast_requisition_type_code == 'QD002') || (ast_requisition_type_code == 'QD008') || (ast_requisition_type_code == 'QD006')) {
                            lovField.setLovService('eam.eam0310.cux_eam0310_exp_requisition_query_gkj');
                        } else {
                            lovField.setLovService('eam.eam0310.eam0310_exp_requisition_query');
                        }
            
                        var records = $('eam0310_req_lines_ds').getCurrentRecord();
                        lovField.setLovPara('ast_requisition_type_id', '${/model/eam0310_req_header/record/@ast_requisition_type_id}');
                        lovField.setLovPara('requisition_line_id', records.get("requisition_line_id"));
                        lovField.setLovPara('unit_id', records.get("to_unit_id"));
                        lovField.setLovPara('asset_id', records.get("asset_id"));
                    }
            
                }
            }
            
            function eam0310_onDocRlsSave() {
                $('eam0310_document_release_ds').query();
            }
            
            function lineNumberEditor(record, name) {
                if (record.get('release_id')) {
                    return '';
                } else {
                    return 'rec_req_comboBox';
                }
            }
            //20160106 行数不超过20行
            
            
            function onadd(dataset) {
                var line_rec = $('eam0310_req_lines_ds').getAll();
                if (line_rec.length >= 20) {
                    Aurora.showErrorMessage('${l:PROMPT}', '请注意，单据行数不能超过20行！', null, 250, 100);
            
                    return false;
                }
            
            
            }
        ]]></script>
        <!-- 声明dataSets -->
        <a:dataSets>
            <!-- 资产账簿DS -->
            <a:dataSet id="eam0310_asset_books_ds" model="eam.eam0310.eam0310_asset_books_query">
                <a:fields>
                    <a:field name="asset_book_id"/>
                    <a:field name="asset_book_desc"/>
                    <a:field name="unit_id"/>
                </a:fields>
            </a:dataSet>
            <!-- 申请类型DS -->
            <a:dataSet id="eam0310_req_type_ds" model="eam.eam0310.eam0310_requisition_types_query">
                <a:fields>
                    <a:field name="requisition_type"/>
                </a:fields>
            </a:dataSet>
            <!-- 岗位DS -->
            <a:dataSet id="eam0310_org_position_ds" model="eam.eam0310.eam0310_exp_org_position_query">
                <a:fields>
                    <a:field name="position_id"/>
                    <a:field name="unit_id"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="eam0310_value_type_ds" lookupCode="EAM_VALUE_TYPE"/>
            <!-- 申请人DS -->
            <a:dataSet id="eam0310_employee_ds">
                <a:datas dataSource="/model/eam0310_employee"/>
            </a:dataSet>
            <!-- 申请头DS -->
            <a:dataSet id="eam0310_req_form_ds" autoCreate="true" model="eam.eam0311.eam0311_requisition_headers_edit">
                <a:fields>
                    <a:field name="company_name" defaultValue="${/model/eam0310_req_header/record/@company_name}" readOnly="true"/>
                    <a:field name="unit_name" defaultValue="${/model/eam0310_req_header/record/@unit_name}" readOnly="true"/>
                    <a:field name="requisition_header_id" defaultValue="${/model/eam0310_req_header/record/@requisition_header_id}"/>
                    <a:field name="requisition_number" defaultValue="${/model/eam0310_req_header/record/@requisition_number}" prompt="ACP_REQUISITION.REQUEST_NO" readOnly="true"/>
                    <a:field name="asset_book_id" defaultValue="${/model/eam0310_req_header/record/@asset_book_id}"/>
                    <a:field name="period_name" defaultValue="${/model/eam0310_req_header/record/@period_name}"/>
                    <a:field name="asset_book_desc" defaultValue="${/model/eam0310_req_header/record/@asset_book_desc}" displayField="asset_book_desc" prompt="EAM_ASSET_CATEGORIES.ASSET_BOOK" readOnly="true"/>
                    <a:field name="ast_requisition_type_id"/>
                    <a:field name="user_group_id"/>
                    <a:field name="unit_id"/>
                    <a:field name="to_unit_id"/>
                    <a:field name="using_unit_desc" autoComplete="true" autoCompleteField="unit_code" lovGridHeight="320" lovHeight="460" lovService="exp.exp_org_unit" lovWidth="500" prompt="使用部门" title="使用部门">
                        <a:mapping>
                            <a:map from="unit_code_name" to="using_unit_desc"/>
                            <a:map from="unit_id" to="to_unit_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="requisition_type" defaultValue="${/model/eam0310_req_header/record/@ast_requisition_type_desc}" prompt="EAM_REQUISITION_TYPES.AST_REQUISITION_TYPE_CODE" readOnly="true"/>
                    <a:field name="requisition_date" defaultValue="${/model/eam0310_req_header/record/@requisition_date}" prompt="AST_REQUISITION_DATE" readOnly="true"/>
                    <a:field name="org_position" defaultValue="${/model/eam0310_req_header/record/@position_name}" displayField="description" options="eam0310_org_position_ds" prompt="AST_REQUISITION_POSITION" readOnly="true"/>
                    <a:field name="req_employee_name" defaultValue="${/model/eam0310_req_header/record/@employee_name}" displayField="employee_name" prompt="EAM_REQUISITION_TYPES.AST_REQUISITION_PROPOSER" readOnly="true"/>
                    <a:field name="employee_name" defaultValue="${/model/eam0310_req_header/record/@employee_name}" prompt="AST_REQUISITION_ORIGINATOR" readOnly="true"/>
                    <a:field name="req_desc" defaultValue="${/model/eam0310_req_header/record/@description}" prompt="AST_REQUISITION_DESC"/>
                    <!-- required="true" -->
                    <a:field name="req_status_desc" defaultValue="${/model/eam0310_req_header/record/@req_status_desc}" prompt="EXP_REQUISITION_HEADERS.REQUISITION_STATUSII" readOnly="true"/>
                    <a:field name="value_type" defaultValue="${/model/eam0310_req_header/record/@value_type}"/>
                    <a:field name="value_type_desc" defaultValue="${/model/eam0310_req_header/record/@value_type_desc}" displayField="code_value_name" options="eam0310_value_type_ds" prompt="EAM_VALUE_TYPE" readOnly="true" returnField="value_type" valueField="code_value"/>
                </a:fields>
                <a:events>
                    <a:event name="successsubmit" handler="eam0311_onReqFormSubmited"/>
                </a:events>
            </a:dataSet>
            <!-- 申请行DS -->
            <a:dataSet id="eam0310_req_lines_ds" bindName="req_lines" bindTarget="eam0310_req_form_ds" fetchAll="true" model="eam.eam0311.eam0311_requisition_lines_edit" selectable="true">
                <!-- pageSize="10" -->
                <a:fields>
                    <a:field name="asset_id"/>
                </a:fields>
                <a:events>
                    <!-- <a:event name="indexchange" handler="eam0310_onReqLinesIndexChange"/> -->
                    <!-- <a:event name="add" handler="eam0310_onReqLinesAdd"/> -->
                    <a:event name="remove" handler="eam0310_onReqLinesDel"/>
                    <!-- <a:event name="beforecreate" handler="onadd"/> -->
                </a:events>
            </a:dataSet>
            <!-- 申请单据关联DS -->
            <!-- <a:dataSet id="eam0310_document_release_ds" bindName="document_cates" bindTarget="eam0310_req_lines_ds" model="eam.eam0310.eam0310_document_req_releases_edit" selectable="true"> -->
            <a:dataSet id="eam0310_document_release_ds" model="eam.eam0310.eam0310_document_req_releases" selectable="true">
                <a:fields>
                    <a:field name="line_number" displayField="line_number" options="eam0310_req_lines_ds" required="true" returnField="requisition_line_id" valueField="requisition_line_id"/>
                    <a:field name="requisition_line_id"/>
                    <a:field name="source_document_category"/>
                    <a:field name="source_document_id"/>
                    <a:field name="source_document_line_id"/>
                    <a:field name="tag_number_old"/>
                    <a:field name="source_doc_cate_desc" displayField="code_value_name" options="eam0310_document_cates_ds" prompt="EAM_DOCUMENT_CATEGORY" readOnly="true" required="true" returnField="source_document_category" valueField="code_value"/>
                    <a:field name="source_doc_desc" lovGridHeight="300" lovHeight="440" lovService="eam.eam0310.cux_eam0310_exp_requisition_query_gkj" lovWidth="1030" prompt="WFL_WORKFLOW.ORDER_NO" required="true" title="MLC_INTER_ORDERS.ORDER_CODE">
                        <a:mapping>
                            <a:map from="exp_requisition_number" to="source_doc_desc"/>
                            <a:map from="line_number" to="source_doc_line_desc"/>
                            <a:map from="exp_requisition_header_id" to="source_document_id"/>
                            <a:map from="exp_requisition_line_id" to="source_document_line_id"/>
                            <a:map from="primary_quantity" to="req_quantity"/>
                            <a:map from="examine_quantity" to="examine_quantity"/>
                            <a:map from="requisition_amount" to="req_amount"/>
                            <a:map from="examine_amount" to="examine_amount"/>
                            <a:map from="req_item_desc" to="req_project"/>
                            <a:map from="req_item_desc" to="req_project"/>
                            <a:map from="release_quantity" to="release_quantity_sum"/>
                            <a:map from="release_amount" to="release_amount_sum"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="examine_quantity" prompt="申请数量"/>
                    <a:field name="examine_amount" prompt="申请金额"/>
                    <a:field name="source_doc_line_desc" prompt="EXP_REPORT_LINES.LINE_NUMBER"/>
                    <a:field name="req_project" prompt="EXP_REQ_ITEMS.REQ_ITEM_CODE"/>
                    <a:field name="req_quantity" prompt="EAM_REQUEST_QUANTITY"/>
                    <a:field name="req_amount" prompt="EAM_REQUEST_AMOUNT"/>
                    <a:field name="release_amount_sum"/>
                    <a:field name="release_quantity" defaultValue="1" prompt="EXP_REQUISITION_DISTS.RELEASED_QUANTITY"/>
                    <a:field name="release_amount" prompt="CSH_WRITE_OFF.CSH_WRITE_OFF_AMOUNT" required="true" validator="docRlsValidator"/>
                    <a:field name="description" prompt="EXP_EMPLOYEE.NOTES"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="eam0310_onDocRlsAdd"/>
                    <a:event name="submitsuccess" handler="eam0310_onDocRlsSave"/>
                </a:events>
            </a:dataSet>
            <!-- 单据分类 -->
            <a:dataSet id="eam0310_document_cates_ds" lookupCode="EAM_REQ_SOURCE_DOCUMENT_CATE" selectable="true"/>
        </a:dataSets>
        <a:screenBody>
            <!-- 申请头 -->
            <a:form column="1" title="REC_REQUISITION_UPDATE" width="1024">
                <a:box column="4" width="1000">
                    <a:textField name="requisition_number" bindTarget="eam0310_req_form_ds" prompt="申请单号"/>
                    <a:comboBox name="value_type_desc" bindTarget="eam0310_req_form_ds"/>
                    <a:textField name="req_status_desc" bindTarget="eam0310_req_form_ds"/>
                    <a:textField name="req_employee_name" bindTarget="eam0310_req_form_ds"/>
                    <a:comboBox name="org_position" bindTarget="eam0310_req_form_ds"/>
                    <a:textField name="asset_book_desc" bindTarget="eam0310_req_form_ds"/>
                    <a:textField name="requisition_type" bindTarget="eam0310_req_form_ds" prompt="申请类型"/>
                    <a:datePicker name="requisition_date" bindTarget="eam0310_req_form_ds"/>
                    <!--<a:textField name="company_name" bindTarget="eam0310_req_form_ds" prompt="机构"/>
                    <a:textField name="unit_name" bindTarget="eam0310_req_form_ds" prompt="部门"/>
                    <a:textField name="employee_name" bindTarget="eam0310_req_form_ds"/>-->
                </a:box>
                <a:hBox>
                    <a:textArea name="req_desc" bindTarget="eam0310_req_form_ds" prompt="摘要" width="895"/>
                </a:hBox>
            </a:form>
            <a:hBox>
                <a:button click="eam0310_save" text="HAP_SAVE"/>
                <a:button click="eam0310_submit" text="HAP_SUBMIT"/>
                <a:button click="eam0310_delete" text="删除整单"/>
                <a:button click="eam0310_back" text="HAP_BACK"/>
                <!-- <a:button id="uploadImageBtn" click="uploadImage" text="影像上传"/> -->
            </a:hBox>
            <a:grid bindTarget="eam0310_req_lines_ds" height="200" navBar="true" width="1024">
                <a:toolBar>
                    <a:button type="add"/>
                    <a:button type="delete"/>
                    <a:button id="batch_creation_id" click="eam0310_batch_creation" icon="${/request/@context_path}/images/add.gif" text="PROMPT.BATCH_ASSET_ADD"/>
                    <a:button id="batch_ref_req_id" click="eam0310_batch_ref_req" icon="${/request/@context_path}/images/add.gif" text="批量前端单据"/>
                </a:toolBar>
                <a:columns>
                    <a:column name="line_number" align="center" width="60"/>
                    <a:column name="asset_name" align="center" width="160"/>
                    <!--<a:column name="contract_name" align="center"/>
                    <a:column name="trans_type_desc" align="center"/>-->
                    <a:column name="contract_name" align="center" width="160"/>
                    <a:column name="price_tax" align="right"/>
                    <a:column name="price_no_tax" align="right"/>
                    <a:column name="tax" align="right"/>
                    <a:column name="transfer_rate" align="right"/>
                    <a:column name="transfer_amount" align="right"/>
                    <a:column name="quantity" align="right" width="50"/>
                    <a:column name="price" align="right" renderer="Aurora.formatMoney"/>
                    <a:column name="amount" align="right" renderer="Aurora.formatMoney"/>
                    <a:column name="using_unit_desc" align="center" prompt="折旧承担部门" width="160"/>
                    <!--<a:column name="acceptance_date" align="center" renderer="Aurora.formatDate"/>-->
                    <a:column name="accptn_check_date" align="center" prompt="验收日期" renderer="Aurora.formatDate"/>
                    <a:column name="description" align="center" width="150"/>
                    <a:column align="center" renderer="eam0310_assetRenderer"/>
                </a:columns>
            </a:grid>
            <!-- 单据关联 -->
            <div id="grid_release_id">
                <a:grid bindTarget="eam0310_document_release_ds" height="200" navBar="true" width="1024">
                    <a:toolBar>
                        <p style="margin-top:6px;color:#336699;margin-left:5px;margin-right:5px;"><![CDATA[关联前端单据]]></p>
                        <a:button id="addButton" type="add"/>
                        <a:button type="save"/>
                        <a:button type="delete"/>
                    </a:toolBar>
                    <a:columns>
                        <a:column name="line_number" align="center" editorFunction="lineNumberEditor" prompt="资产申请单行号" width="90"/>
                        <a:column name="source_doc_cate_desc" align="center" prompt="单据类型" width="80"/>
                        <a:column name="source_doc_desc" align="center" editor="rec_req_lov" prompt="单据编号" width="170"/>
                        <a:column name="source_doc_line_desc" align="center" prompt="单据行号" width="70"/>
                        <a:column name="unit_name" align="center" prompt="费用部门" width="70"/>
                        <a:column name="req_project" align="center" prompt="费用项目"/>
                        <a:column name="req_quantity" align="right" prompt="数量" width="40"/>
                        <a:column name="price" align="right" prompt="单价" renderer="Aurora.formatMoney" width="100"/>
                        <a:column name="req_amount" align="right" prompt="行金额" renderer="Aurora.formatMoney" width="100"/>
                        <!-- <a:column name="release_quantity" align="right" editor="rec_req_quantity" prompt="核销数量"/> -->
                        <a:column name="release_amount" align="right" editor="rec_req_money" prompt="本次核销金额" renderer="Aurora.formatMoney" width="100"/>
                        <a:column name="description" align="center" editor="rec_req_txtField" width="150"/>
                    </a:columns>
                    <a:editors>
                        <a:comboBox id="rec_req_comboBox"/>
                        <a:lov id="rec_req_lov"/>
                        <a:textField id="rec_req_txtField"/>
                        <a:numberField id="rec_req_quantity" allowDecimals="false" allowNegative="false"/>
                        <a:numberField id="rec_req_money" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="2"/>
                    </a:editors>
                    <a:events>
                        <a:event name="cellclick" handler="eam_onCellClickFun"/>
                    </a:events>
                </a:grid>
            </div>
        </a:screenBody>
    </a:view>
</a:screen>
