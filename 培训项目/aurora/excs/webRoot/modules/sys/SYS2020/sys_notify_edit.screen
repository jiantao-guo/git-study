<?xml version="1.0" encoding="UTF-8"?>
<a:screen xmlns:a="http://www.aurora-framework.org/application" xmlns:p="uncertain.proc" trace="true">
    <a:init-procedure>
        <p:echo/>
        <a:model-query autoCount="true" defaultWhereClause="notify_id=${/parameter/@notify_id}" fetchAll="true" model="sys.SYS2020.sys_notify" rootPath="sys_notify_edit"/>
        <a:model-query defaultWhereClause=" cs.code = &apos;SYS_NOTIFY_SEND_METHOD&apos;" fetchAll="true" model="sys.SYS2020.sys_notify_code_codevalue" rootPath="send_method"/>
        <a:model-query defaultWhereClause=" cs.code = &apos;SYS_NOTIFY_SEND_MODE&apos;" fetchAll="true" model="sys.SYS2020.sys_notify_code_codevalue" rootPath="send_mode"/>
        <a:model-query defaultWhereClause=" cs.code = &apos;SYS_NOTIFY_DELAY_TIME_UNIT&apos;" fetchAll="true" model="sys.SYS2020.sys_notify_code_codevalue" rootPath="delay_time_unit"/>
        <a:model-query defaultWhereClause=" snrt.enabled_flag = &apos;Y&apos; " fetchAll="true" model="sys.SYS2020.sys_notify_recipient_type" rootPath="recipientType"/>
    </a:init-procedure>
    <a:view>
        <script><![CDATA[
        
            function onNotifyRecipientUpdate(ds,record,name,value){
                if (name=='recipient_type_id'){
                    record.set('recipient_name', '');
                    record.set('recipient_user_id', '');
                }
            }

            function onFieldSetUpdate(ds,record,name,value){
                if(name=='send_mode'){
                    var send_mode=record.get('send_mode');

                    var delay_time_unit_display=record.getMeta().getField('delay_time_unit_display');
                    var delay_time=record.getMeta().getField('delay_time');
                    if (send_mode=='02'){
                        delay_time_unit_display.setReadOnly(false);
                        delay_time.setReadOnly(false);
                    }else{
                        delay_time_unit_display.setReadOnly(true);
                        delay_time.setReadOnly(true);

                        record.set('delay_time_unit_display',null);
                        record.set('delay_time',null);
                        record.set('delay_time_unit',null);
                    }
                }
            }

            function onFieldSetInit(){
                var record = $('sys_notify_edit_ds').getCurrentRecord();
                var send_mode=record.get('send_mode');
                var delay_time_unit_display=record.getMeta().getField('delay_time_unit_display');
                var delay_time=record.getMeta().getField('delay_time');
                if (send_mode=='02'){
                    delay_time_unit_display.setReadOnly(false);
                    delay_time.setReadOnly(false);
                }else{
                    delay_time_unit_display.setReadOnly(true);
                    delay_time.setReadOnly(true);
                    record.set('delay_time_unit_display',null);
                    record.set('delay_time',null);
                    record.set('delay_time_unit',null);
                }
            }

            function onCellClick(grid, row, name, record){
                if(name =='recipient_name_display'){
                    var recipient_type_id = record.get('recipient_type_id');
                    var url=null;
                    var sql_text=null;

                    if (recipient_type_id==null||recipient_type_id==''){
                        return;
                    }

                    var allRecords=$('sys_recipient_type_ds').getAll();
                    if (allRecords==null||allRecords==''||allRecords==undefined){
                        return;
                    }
                    for(var k = 0,l=allRecords.length;k<l;k++){
                        var rcd = allRecords[k];
                        if (rcd.get('recipient_type_id')==recipient_type_id){
                            url=rcd.get('lov_url');
                            sql_text=rcd.get('desc_fetch_sql');
                            break;
                        }
                    }

                    var recipient_name_display=record.getMeta().getField('recipient_name_display');
                    recipient_name_display.setLovPara('sql_text',sql_text);
                    recipient_name_display.setLovService(url);
                }
            }

            function saveFunction(){
                var ds=$('sys_notify_edit_ds');
                var gridDs=$('sys_notify_recipient_ds');
                if (ds.validate()&&gridDs.validate()){
                    ds.submit();
                }
            }

            function closeWindow(){
                $('sys_notify_edit').close();
            }

            function showsuccessmessage(ds,res){
               Aurora.showMessage('${l:PROMPT}','${l:BGT_STRUCTURE.OPERATE_SUCCESS}');
               $('sys_notify_recipient_ds').query();
            }
        
        	function deleteLines(){
        		$('sys_notify_edit_ds').getAt(0).set('_isdelete','delete');
        		var rs = $('sys_notify_recipient_ds').getSelected();
        		
        		for(var i = 0 ; i < rs.length ; i ++){
        		    if(rs[i].isNew){
        		        $('sys_notify_recipient_ds').removeLocal(rs[i]);
        		    }
        		}
        		
        		rs =  $('sys_notify_recipient_ds').getSelected();
        		
        		if(rs.length != 0){
        		    for(var i = 0 ; i < rs.length ; i ++){
	        			rs[i].set('__delete','true');
	        		}
	        		$('sys_notify_edit_ds').submit();
        		}
        	}
        
        ]]></script>
        <a:dataSets>
            <a:dataSet id="sys_ds" model="sys.SYS2020.sys_notify"/>
            <a:dataSet id="sys_notify_sendMethod_ds">
                <a:datas dataSource="/model/send_method"/>
            </a:dataSet>
            <a:dataSet id="sys_notify_sendMode_ds">
                <a:datas dataSource="/model/send_mode"/>
            </a:dataSet>
            <a:dataSet id="sys_notify_delayTimeUnit_ds">
                <a:datas dataSource="/model/delay_time_unit"/>
            </a:dataSet>
            <a:dataSet id="sys_recipient_type_ds">
                <a:datas dataSource="/model/recipientType"/>
            </a:dataSet>
            <a:dataSet id="sys_notify_edit_ds" submitUrl="${/request/@context_path}/modules/sys/SYS2020/sys_notify_edit_update.svc">
                <a:datas dataSource="/model/sys_notify_edit"/>
                <a:fields>
                    <a:field name="notify_id" defaultValue="${/parameter/@notify_id}"/>
                    <a:field name="notify_code" readOnly="true"/>
                    <a:field name="description" required="true"/>
                    <a:field name="send_method_display" displayField="code_value_name" options="sys_notify_sendMethod_ds" returnField="send_method" valueField="code_value"/>
                    <a:field name="send_mode_display" displayField="code_value_name" options="sys_notify_sendMode_ds" returnField="send_mode" valueField="code_value"/>
                    <a:field name="delay_time_unit_display" displayField="code_value_name" options="sys_notify_delayTimeUnit_ds" returnField="delay_time_unit" valueField="code_value"/>
                    <a:field name="enabled_flag" checkedValue="Y" defaultValue="Y" uncheckedValue="N"/>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="onFieldSetUpdate"/>
                    <a:event name="submitsuccess" handler="showsuccessmessage"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="sys_notify_recipient_ds" autoPageSize="true" autoQuery="true" bindName="recipients" bindTarget="sys_notify_edit_ds" queryUrl="${/request/@context_path}/autocrud/sys.SYS2020.sys_notify_recipient_query/query?ORDER_FIELD=recipient_id&amp;notify_id=${/parameter/@notify_id}" selectable="true">
                <a:fields>
                    <a:field name="recipient_type_display" displayField="description" options="sys_recipient_type_ds" required="true" returnField="recipient_type_id" valueField="recipient_type_id"/>
                    <a:field name="recipient_name_display" lovGridHeight="320" lovHeight="440" lovWidth="500" title="RECIEVER_SELECT">
                        <a:mapping>
                            <a:map from="description" to="recipient_name_display"/>
                            <a:map from="notify_code" to="notify_code"/>
                            <a:map from="notify_id" to="recipient_name"/>
                            <a:map from="recipient_user_id" to="recipient_user_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="enabled_flag" checkedValue="Y" defaultValue="Y" uncheckedValue="N"/>
                    <a:field name="notify_id" defaultValue="${/parameter/@notify_id}"/>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="onNotifyRecipientUpdate"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <a:screenBody>
            <a:screenTopToolbar>
                <a:screenTitle/>
                <a:toolbarButton click="saveFunction" text="HAP_SAVE" width="80"/>
                <a:toolbarButton click="closeWindow" text="HAP_CLOSE" width="80"/>
            </a:screenTopToolbar>
            <a:tabPanel marginHeight="90" marginWidth="28">
                <a:tabs>
                    <a:tab prompt="SYS_NOTIFY_EDIT.TAB_TITLE1" width="110">
                        <a:form id="NOTIFY_EDIT_form" labelWidth="95" title="SYS_NOTIFY_EDIT.NEW">
                            <a:hBox prompt="SYS_MESSAGES.MESSAGE_CODE">
                                <a:textField name="notify_code" bindTarget="sys_notify_edit_ds" typeCase="upper"/>
                                <a:textField name="description" bindTarget="sys_notify_edit_ds" prompt="SYS_MESSAGES.MESSAGE_NAME"/>
                            </a:hBox>
                            <a:hBox prompt="SYS_NOTIFY.MESSAGE_TITLE">
                                <a:textField name="message_title" bindTarget="sys_notify_edit_ds" width="380"/>
                            </a:hBox>
                            <a:hBox prompt="SYS_NOTIFY.MESSAGE_CONTENT">
                                <a:textArea name="message_content" bindTarget="sys_notify_edit_ds" width="380"/>
                            </a:hBox>
                            <a:hBox prompt="SYS_NOTIFY.SEND_METHOD">
                                <a:comboBox name="send_method_display" bindTarget="sys_notify_edit_ds"/>
                                <a:comboBox name="send_mode_display" bindTarget="sys_notify_edit_ds" prompt="SYS_NOTIFY.SEND_MODE"/>
                            </a:hBox>
                            <a:hBox prompt="SYS_NOTIFY.DELAY_TIME">
                                <a:numberField name="delay_time" bindTarget="sys_notify_edit_ds"/>
                                <a:comboBox name="delay_time_unit_display" bindTarget="sys_notify_edit_ds" prompt="SYS_NOTIFY_RECIPIENT.DELAY_TIME_UNIT"/>
                            </a:hBox>
                            <a:hBox prompt="SYS_NOTIFY.CONTENT_SQL">
                                <a:textArea name="content_sql" bindTarget="sys_notify_edit_ds" width="380"/>
                            </a:hBox>
                            <a:hBox prompt="SYS_NOTIFY.MSG_SEND_CHECK_PROC">
                                <a:textField name="msg_send_check_proc" bindTarget="sys_notify_edit_ds" width="380"/>
                            </a:hBox>
                            <a:hBox prompt="SYS_NOTIFY.MSG_CREATE_PROC">
                                <a:textField name="msg_create_proc" bindTarget="sys_notify_edit_ds"/>
                                <a:checkBox name="enabled_flag" bindTarget="sys_notify_edit_ds" prompt="FND_OPERATION_UNITS.ENABLED_FLAG"/>
                            </a:hBox>
                        </a:form>
                    </a:tab>
                    <a:tab prompt="SYS_NOTIFY_RECIPIENT.RECIPIENT_NAME" width="110">
                        <a:grid id="edit_grid" bindTarget="sys_notify_recipient_ds" marginHeight="122" navBar="true">
                            <a:toolBar>
                                <a:button type="add"/>
                                <a:button click="deleteLines" icon="${/request/@context_path}/images/remove.gif" text="PROMPT.DELETE"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="recipient_type_display" editor="edit_grid_comboBox" prompt="SYS_NOTIFY_RECIPIENT.RECIPIENT_TYPE" sortable="true"/>
                                <a:column name="recipient_name_display" editor="edit_grid_lov" prompt="SYS_NOTIFY_RECIPIENT.RECIPIENT_NAME" sortable="true"/>
                                <a:column name="recipient_mobile" editor="edit_grid_tf" prompt="SYS_NOTIFY_RECIPIENT.RECIPIENT_MOBILE" sortable="true"/>
                                <a:column name="recipient_mail" editor="edit_grid_tf" prompt="SYS_NOTIFY_RECIPIENT.EMAIL" sortable="true"/>
                                <a:column name="param1" editor="edit_grid_tf" prompt="SYS_NOTIFY_RECIPIENT.PARAM1" sortable="true"/>
                                <a:column name="param2" editor="edit_grid_tf" prompt="SYS_NOTIFY_RECIPIENT.PARAM2" sortable="true"/>
                                <a:column name="param3" editor="edit_grid_tf" prompt="SYS_NOTIFY_RECIPIENT.PARAM3" sortable="true"/>
                                <a:column name="param4" editor="edit_grid_tf" prompt="SYS_NOTIFY_RECIPIENT.PARAM4" sortable="true"/>
                                <a:column name="recipient_desc" editor="edit_grid_tf" prompt="WFL_WORKFLOW_PARAM_VALUE.VALUE_DESC" sortable="true"/>
                                <a:column name="enabled_flag" editor="edit_grid_checkBox" prompt="FND_OPERATION_UNITS.ENABLED_FLAG" sortable="true"/>
                            </a:columns>
                            <a:editors>
                                <a:textField id="edit_grid_tf"/>
                                <a:checkBox id="edit_grid_checkBox"/>
                                <a:comboBox id="edit_grid_comboBox"/>
                                <a:lov id="edit_grid_lov"/>
                            </a:editors>
                            <a:events>
                                <a:event name="cellClick" handler="onCellClick"/>
                            </a:events>
                        </a:grid>
                    </a:tab>
                </a:tabs>
            </a:tabPanel>
            <script><![CDATA[
	            onFieldSetInit(); 
	        ]]></script>
        </a:screenBody>
        <script purpose="auto_resize"><![CDATA[

            function expRptPayQueryInitSize() {
                //描述宽度
            　　    var labelWidth = 75;
            　　    //标签宽度,5 = 3padding + 2border-spacing
            　　    var tagWidth = 150 + 5;
            　　    //页面宽度、高度
            　　    var vw = $A.getViewportWidth();
            　　    var vh = $A.getViewportHeight();
            　　    //留白宽度
            　　    var marginWidth = 35;
            　　    //自适应宽度
            　　    var autoWidth = vw - marginWidth;
            　　    //Form内部宽度，-2border
            　　    var formInnerWidth = autoWidth - 2;
            　　    //所占列数
            　　    var colSpan = 4;
            　　    //设置组件的自适应宽度
           // alert('1213');
            	  Ext.get('NOTIFY_EDIT_form').setWidth(autoWidth+4-6);
            	  $('edit_grid').setWidth(autoWidth+4-10);
            	   
            }
            //Ext.fly(window).on('resize', expRptPayQueryInitSize);
            expRptPayQueryInitSize();
            
        ]]></script>
    </a:view>
</a:screen>
